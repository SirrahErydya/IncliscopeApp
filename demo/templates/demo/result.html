<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Incliscope</title>
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'demo/style.css' %}">
    <!--<script type="text/javascript" src="{% static 'main/heatmap.js' %}"></script>-->
     <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <a class="button" href="{% url 'survey' %}">Try again</a>
    <h1>You guessed an inclination of {{ guess|floatformat:2 }}° for galaxy {{ galaxy.name }}!</h1>
    <p>In truth, its inclination was <b>{{ galaxy.i_mean|floatformat:2 }}°.</b></p>
    <p><b>Incliscope</b> predicted an inclination of <b>{{ predicted_mean|floatformat:2 }}°.</b></p>
    {% if beat_incliscope %}
        <h2>You beat Incliscope about {{ guess_pred_diff|floatformat:2 }}°!</h2>
    {% else %}
        <h2>Incliscope beat you about {{ guess_pred_diff|floatformat:2 }}°!</h2>
    {% endif %}
    <div class="res-left">
        <img src="{{ galaxy.image }}">
    </div>
    <div class="res-right">
         <canvas id="incliscope_graph" style="width:100%;"></canvas>
         <script>
            const xValues = {{ x_values }};
            
            const verticalLinePlugin = {
               getLinePosition: function (chart, pointIndex) {
                   const meta = chart.getDatasetMeta(0); // first dataset is used to discover X coordinate of a point
                   const data = meta.data;
                   return data[pointIndex].x;
               },
            
               renderVerticalLine: function (chartInstance, pointIndex) {
                   const lineLeftOffset = this.getLinePosition(chartInstance, pointIndex);
                   const scale = chartInstance.scales.y;
                   const context = chartInstance.ctx;
                   // render vertical line
                   context.beginPath();
                   context.strokeStyle = '#ff0000';
                   context.moveTo(lineLeftOffset, scale.top);
                   context.lineTo(lineLeftOffset, scale.bottom);
                   context.stroke();
            
                   // write label
                   context.fillStyle = "#ff0000";
                   context.textAlign = 'center';
                   context.fillText('Your guess', lineLeftOffset, (scale.bottom - scale.top) / 2 + scale.top);
               },

               beforeDatasetsDraw: function (chart, easing) {
                   if(chart.config._config.lineAtIndex)
                       chart.config._config.lineAtIndex.forEach(pointIndex => this.renderVerticalLine(chart, pointIndex));
               }
            };

            new Chart("incliscope_graph", {
              type: "line",
              data: {
                labels: xValues,
                datasets: [{
                  data: {{ n_gt }},
                  borderColor: "green",
                  fill: false,
                  label: "Ground Truth"
                },{
                  data: {{ n_pred }},
                  borderColor: "blue",
                  fill: false,
                  label: "Incliscope Prediction"
                }]
              },
              options: {
                scales: {
                    x: {
                        ticks: {
                            callback: function (value, index, ticks) {
                                v = this.getLabelForValue(value)
                                return v.toFixed(2);
                            }
                        },
                        title: {
                            display: true,
                            text: "Inclination (deg)"
                        }
                    },
                    y: {
                        min: 0.,
                        max: {{ max_y }}
                    }
                }
              },
              lineAtIndex: [ {{ guess_idx }}],
              plugins: [verticalLinePlugin]
            });
         </script>
    </div>
</body>
</html>
